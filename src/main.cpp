#include "main.h"
//#include <stdio.h>

// ???????????��?��?STM32F103???????
#define RCC_APB2ENR (*(volatile unsigned int *)0x40021018)
#define GPIOC_CRH (*(volatile unsigned int *)0x40011004)
#define GPIOC_ODR (*(volatile unsigned int *)0x4001100C)

// ???????
void delay_ms(unsigned int ms)
{
	unsigned int i, j;
	for (i = 0; i < ms; i++)
		for (j = 0; j < 7200; j++)
			; // ????1ms???????????????????
}

void a(core *c)
{
	//printf("aasa");
	_u32 *d = (_u32 *)c->malloc(32);
	*d = 20;
	// ???GPIOC???
	RCC_APB2ENR |= (1 << 4); // ??4��??GPIOC????????��

	// ????PC13????????
	// PC13��??CRH???20-23��
	GPIOC_CRH &= ~(0xF << 20); // ??????????
	GPIOC_CRH |= (0x3 << 20);  // ??????????????50MHz

	while (1)
	{
		// ???PC13????
		GPIOC_ODR ^= (1 << 13);

		// ???500ms
		delay_ms(*d);
	}
}

int main()

{
	dispatcher s; // ??????????s
	s.init();	  // ???????????

	s.create(a, 0); // ?????b

	s.exec(); // ??????????
}
